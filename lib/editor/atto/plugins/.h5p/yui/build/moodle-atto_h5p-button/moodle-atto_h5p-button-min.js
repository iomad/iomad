YUI.add("moodle-atto_h5p-button",function(p,t){var h={CONTENTWARNING:"att_h5p_contentwarning",H5PBROWSER:"openh5pbrowser",INPUTALT:"atto_h5p_altentry",INPUTH5PFILE:"atto_h5p_file",INPUTSUBMIT:"atto_h5p_urlentrysubmit",OPTION_DOWNLOAD_BUTTON:"atto_h5p_option_download_button",OPTION_COPYRIGHT_BUTTON:"atto_h5p_option_copyright_button",OPTION_EMBED_BUTTON:"atto_h5p_option_embed_button",URLWARNING:"atto_h5p_warning"},r={CONTENTWARNING:"."+h.CONTENTWARNING,H5PBROWSER:"."+h.H5PBROWSER,INPUTH5PFILE:"."+h.INPUTH5PFILE,INPUTSUBMIT:"."+h.INPUTSUBMIT,OPTION_DOWNLOAD_BUTTON:"."+h.OPTION_DOWNLOAD_BUTTON,OPTION_COPYRIGHT_BUTTON:"."+h.OPTION_COPYRIGHT_BUTTON,OPTION_EMBED_BUTTON:"."+h.OPTION_EMBED_BUTTON,URLWARNING:"."+h.URLWARNING},_="atto_h5p",m='{{#if addParagraphs}}<p><br></p>{{/if}}<div class="h5p-placeholder" contenteditable="false">{{{url}}}</div>{{#if addParagraphs}}<p><br></p>{{/if}}';p.namespace("M.atto_h5p").Button=p.Base.create("button",p.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_form:null,_H5PDiv:null,_allowedmethods:"none",initializer:function(){this._allowedmethods=this.get("allowedmethods"),"none"!==this._allowedmethods&&(this.addButton({icon:"icon",iconComponent:"atto_h5p",callback:this._displayDialogue,tags:".h5p-placeholder",tagMatchRequiresAll:!1}),this.editor.all(".h5p-placeholder").setAttribute("contenteditable","false"),this.editor.delegate("dblclick",this._handleDblClick,".h5p-placeholder",this),this.editor.delegate("click",this._handleClick,".h5p-placeholder",this))},_handleDblClick:function(){this._displayDialogue()},_handleClick:function(t){var e=this.get("host").getSelectionFromNode(t.target);this.get("host").getSelection()!==e&&this.get("host").setSelection(e)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(this._getH5PDiv(),this.getDialogue({headerContent:M.util.get_string("pluginname",_),width:"auto",focusAfterHide:!0}).set("bodyContent",this._getDialogueContent()).show(),M.form.shortforms({formid:this.get("host").get("elementid")+"_atto_h5p_form"}))},_getH5PDiv:function(){var t=this.get("host").getSelectedNodes(),e=null;t.each(function(t){t.hasClass("h5p-placeholder")&&(e=t)}),this._H5PDiv=e},_getPermissions:function(){var t={canEmbed:!1,canUpload:!1,canUploadAndEmbed:!1};return this.get("host").canShowFilepicker("h5p")&&("both"===this._allowedmethods?(t.canUploadAndEmbed=!0,t.canUpload=!0):"upload"===this._allowedmethods&&(t.canUpload=!0)),"both"!==this._allowedmethods&&"embed"!==this._allowedmethods||(t.canEmbed=!0),t},_getDialogueContent:function(){var t,e,o,n,i,l,a,s,d,c=this._getPermissions(),r=!0;return this._H5PDiv&&(i=this._H5PDiv.get("innerHTML"),(l=M.cfg.wwwroot+"/draftfile.php")==i.substring(0,l.length)?(t=i.split("?")[0],(a=i.split("?")[1])&&(a.match(/export=1/)&&(r=!(e="checked")),a.match(/embed=1/)&&(r=!(o="checked")),a.match(/copyright=1/)&&(r=!(n="checked")))):t=i),s=p.Handlebars.compile('<form class="atto_form mform" id="{{elementid}}_atto_h5p_form"><div style="display:none" role="alert" class="alert alert-warning mb-1 {{CSS.CONTENTWARNING}}">{{get_string "noh5pcontent" component}}</div><div style="display:none" role="alert" class="alert alert-warning mb-1 {{CSS.URLWARNING}}">{{get_string "invalidh5purl" component}}</div>{{#if canUploadAndEmbed}}<div class="mt-2 mb-4 attoh5pinstructions">{{{get_string "instructions" component}}}</div>{{/if}}<div class="mb-4"><label for="{{elementid}}_{{CSS.H5PBROWSER}}">{{#if canUploadAndEmbed}}{{get_string "h5pfileorurl" component}}{{/if}}{{^if canUploadAndEmbed}}{{#if canUpload}}{{get_string "h5pfile" component}}{{/if}}{{#if canEmbed}}{{get_string "h5purl" component}}{{/if}}{{/if}}</label><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTH5PFILE}}" type="url" value="{{fileURL}}" id="{{elementid}}_{{CSS.INPUTH5PFILE}}" data-region="h5pfile" size="32"/>{{#if canUpload}}<span class="input-group-append"><button class="btn btn-secondary {{CSS.H5PBROWSER}}" type="button">{{get_string "browserepositories" component}}</button></span>{{/if}}</div>{{#if canUpload}}<fieldset class="collapsible {{#if collapseOptions}}collapsed{{/if}}" id="{{elementid}}_h5poptions"><legend class="ftoggler">{{get_string "h5poptions" component}}</legend><div class="fcontainer"><div class="form-check"><input type="checkbox" {{optionDownloadButton}} class="form-check-input {{CSS.OPTION_DOWNLOAD_BUTTON}}"aria-label="{{get_string "downloadbutton" component}}" id="{{elementid}}_h5p-option-allow-download"/><label class="form-check-label" for="{{elementid}}_h5p-option-allow-download">{{get_string "downloadbutton" component}}</label></div><div class="form-check"><input type="checkbox" {{optionEmbedButton}} class="form-check-input {{CSS.OPTION_EMBED_BUTTON}}" aria-label="{{get_string "embedbutton" component}}" id="{{elementid}}_h5p-option-embed-button"/><label class="form-check-label" for="{{elementid}}_h5p-option-embed-button">{{get_string "embedbutton" component}}</label></div><div class="form-check mb-2"><input type="checkbox" {{optionCopyrightButton}} class="form-check-input {{CSS.OPTION_COPYRIGHT_BUTTON}}" aria-label="{{get_string "copyrightbutton" component}}" id="{{elementid}}_h5p-option-copyright-button"/><label class="form-check-label" for="{{elementid}}_h5p-option-copyright-button">{{get_string "copyrightbutton" component}}</label></div></div></fieldset>{{/if}}</div><div class="text-center"><button class="btn btn-secondary {{CSS.INPUTSUBMIT}}" type="submit">{{get_string "pluginname" component}}</button></div></form>'),d=p.Node.create(s({elementid:this.get("host").get("elementid"),CSS:h,component:_,canUpload:c.canUpload,canEmbed:c.canEmbed,canUploadAndEmbed:c.canUploadAndEmbed,collapseOptions:r,fileURL:t,optionDownloadButton:e,optionEmbedButton:o,optionCopyrightButton:n})),this._form=d,this._setEventListeners(),d},_filepickerCallback:function(t){""!==t.url&&(this._form.one(r.INPUTH5PFILE).set("value",t.url),this._removeWarnings())},
_setEventListeners:function(){var t=this._form,e=this._getPermissions();t.one(r.INPUTSUBMIT).on("click",this._setH5P,this),e.canUpload&&t.one(r.H5PBROWSER).on("click",function(){this.get("host").showFilepicker("h5p",this._filepickerCallback,this)},this),e.canUploadAndEmbed&&t.one(r.INPUTH5PFILE).on("change",function(){this._removeWarnings()},this)},_removeWarnings:function(){var t=this._form;t.one(r.URLWARNING).setStyle("display","none"),t.one(r.CONTENTWARNING).setStyle("display","none")},_setH5P:function(t){var e,o,n,i,l,a=this._form,s=this.get("host"),d=a.one(r.INPUTH5PFILE).get("value"),c=this._getPermissions();if(t.preventDefault(),!this._updateWarning()){if(s.focus(),o=!0,this._H5PDiv&&(this._H5PDiv.remove(),o=!1),""!==d){if(s.setSelection(this._currentSelection),d.startsWith(M.cfg.wwwroot)){if(n="",c.canUpload)for(l in i={},a.one(r.OPTION_DOWNLOAD_BUTTON).get("checked")&&(i["export"]="1"),a.one(r.OPTION_EMBED_BUTTON).get("checked")&&(i.embed="1"),a.one(r.OPTION_COPYRIGHT_BUTTON).get("checked")&&(i.copyright="1"),i)""===n&&-1===d.indexOf("?")?n+="?":n+="&amp;",n+=l+"="+i[l];e=p.Handlebars.compile(m)({url:d+n,addParagraphs:o})}else e=p.Handlebars.compile(m)({url:d});s.insertContentAtFocusPoint(e),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()}},_validEmbed:function(t){return!!new RegExp("^(<iframe).*(<\\/iframe>)").test(t)},_validURL:function(t){return!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*").test(t)},_updateWarning:function(){var t,e=this._form,o=!0,n=this._getPermissions();return(n.canUpload||n.canEmbed)&&(o=""!==(t=e.one(r.INPUTH5PFILE).get("value"))?(e.one(r.CONTENTWARNING).setStyle("display","none"),t.startsWith(M.cfg.wwwroot)||this._validURL(t)?(e.one(r.URLWARNING).setStyle("display","none"),!1):(e.one(r.URLWARNING).setStyle("display","block"),!0)):(e.one(r.CONTENTWARNING).setStyle("display","block"),!0)),o}},{ATTRS:{allowedmethods:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});