{"version":3,"sources":["../src/form_competency_element.js"],"names":["define","$","Picker","Ajax","Notification","Templates","pickerInstance","pageContextId","renderCompetencies","currentCompetencies","val","requests","i","split","length","methodname","args","id","when","apply","call","then","competencies","arguments","render","html","js","replaceNode","fail","exception","unpickCompetenciesHandler","e","newCompetencies","toRemove","currentTarget","data","join","pickCompetenciesHandler","on","before","compIds","competencyIds","concat","value","setDisallowedCompetencyIDs","display","init","contextId"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Badge select competency actions\n *\n * @module     tool_lp/form_competency_element\n * @package    tool_lp\n * @copyright  2019 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'tool_lp/competencypicker', 'core/ajax', 'core/notification', 'core/templates'],\n        function($, Picker, Ajax, Notification, Templates) {\n\n    var pickerInstance = null;\n\n    var pageContextId = 1;\n\n    /**\n     * Re-render the list of selected competencies.\n     *\n     * @method renderCompetencies\n     * @return {boolean}\n     */\n    var renderCompetencies = function() {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val();\n        var requests = [];\n        var i = 0;\n\n        if (currentCompetencies != '') {\n            currentCompetencies = currentCompetencies.split(',');\n            for (i = 0; i < currentCompetencies.length; i++) {\n                requests[requests.length] = {\n                    methodname: 'core_competency_read_competency',\n                    args: {id: currentCompetencies[i]}\n                };\n            }\n        }\n\n        $.when.apply($, Ajax.call(requests, false)).then(function() {\n            var i = 0,\n                competencies = [];\n\n            for (i = 0; i < arguments.length; i++) {\n                competencies[i] = arguments[i];\n            }\n            var context = {\n                competencies: competencies\n            };\n\n            return Templates.render('tool_lp/form_competency_list', context);\n        }).then(function(html, js) {\n            Templates.replaceNode($('[data-region=\"competencies\"]'), html, js);\n            return true;\n        }).fail(Notification.exception);\n\n        return true;\n    };\n\n    /**\n     * Deselect a competency\n     *\n     * @method unpickCompetenciesHandler\n     * @param {Event} e\n     * @return {boolean}\n     */\n    var unpickCompetenciesHandler = function(e) {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(','),\n            newCompetencies = [],\n            i,\n            toRemove = $(e.currentTarget).data('id');\n\n        for (i = 0; i < currentCompetencies.length; i++) {\n            if (currentCompetencies[i] != toRemove) {\n                newCompetencies[newCompetencies.length] = currentCompetencies[i];\n            }\n        }\n\n        $('[data-action=\"competencies\"]').val(newCompetencies.join(','));\n\n        return renderCompetencies();\n    };\n\n    /**\n     * Open a competencies popup to relate competencies.\n     *\n     * @method pickCompetenciesHandler\n     */\n    var pickCompetenciesHandler = function() {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(',');\n\n        if (!pickerInstance) {\n            pickerInstance = new Picker(pageContextId, false, 'parents', true);\n            pickerInstance.on('save', function(e, data) {\n                var before = $('[data-action=\"competencies\"]').val();\n                var compIds = data.competencyIds;\n                if (before != '') {\n                    compIds = compIds.concat(before.split(','));\n                }\n                var value = compIds.join(',');\n\n                $('[data-action=\"competencies\"]').val(value);\n\n                return renderCompetencies();\n            });\n        }\n\n        pickerInstance.setDisallowedCompetencyIDs(currentCompetencies);\n        pickerInstance.display();\n    };\n\n    return /** @alias module:tool_lp/form_competency_element */ {\n        /**\n         * Listen for clicks on the competency picker and push the changes to the form element.\n         *\n         * @method init\n         * @param {Integer} contextId\n         */\n        init: function(contextId) {\n            pageContextId = contextId;\n            renderCompetencies();\n            $('[data-action=\"select-competencies\"]').on('click', pickCompetenciesHandler);\n            $('body').on('click', '[data-action=\"deselect-competency\"]', unpickCompetenciesHandler);\n        }\n    };\n});\n"],"file":"form_competency_element.min.js"}